name: CI BlazorPong

on:
  push:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'src/**'
      - '.github/workflows/ci.yml'

jobs:
  test-application:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Wait 2 minutes so new images are available
        run: sleep 120

      - name: Start services with Docker Compose, test
        run: docker compose -f src/docker-compose.ci.yml up -d

      - name: Wait for webapp and check health
        run: |
          echo "Waiting for services to start..."
          MAX_WAIT_SECONDS=180 # Wait for a maximum of 3 minutes
          INTERVAL_SECONDS=10
          ELAPSED_SECONDS=0
          WEBAPP_URL="http://localhost:6350" # Port 6350 is mapped from webapp:8080

          while [ $ELAPSED_SECONDS -lt $MAX_WAIT_SECONDS ]; do
            STATUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" $WEBAPP_URL || echo "000")
            if [ "$STATUS_CODE" -eq 200 ]; then
              echo "Webapp is up and running! Received status $STATUS_CODE from $WEBAPP_URL."
              exit 0
            fi
            echo "Webapp not ready (status: $STATUS_CODE from $WEBAPP_URL). Retrying in $INTERVAL_SECONDS seconds..."
            sleep $INTERVAL_SECONDS
            ELAPSED_SECONDS=$((ELAPSED_SECONDS + INTERVAL_SECONDS))
          done

          echo "Timeout: Webapp did not become healthy at $WEBAPP_URL after $MAX_WAIT_SECONDS seconds. Last status: $STATUS_CODE"
          echo "Dumping Docker logs..."
          docker compose -f src/docker-compose.nobuild.yml logs
          exit 1

      - name: Wait for tests to complete by reading the logs of the playwright container
        run: |
          echo "Waiting for Playwright tests to complete..."
          MAX_WAIT_SECONDS=180 # Wait for a maximum of 3 minutes
          INTERVAL_SECONDS=10
          ELAPSED_SECONDS=0
          PLAYWRIGHT_CONTAINER="playwright" # The container running the Playwright tests

          while [ $ELAPSED_SECONDS -lt $MAX_WAIT_SECONDS ]; do
            LOGS=$(docker logs $PLAYWRIGHT_CONTAINER 2>&1)
            if echo "$LOGS" | grep -q "All tests passed"; then
              echo "Playwright tests completed successfully."
              echo "Dumping Docker logs of the whole compose setup..."
              docker compose -f src/docker-compose.ci.yml logs
              exit 0
            fi
            echo "Playwright tests not yet completed. Retrying in $INTERVAL_SECONDS seconds..."
            sleep $INTERVAL_SECONDS
            ELAPSED_SECONDS=$((ELAPSED_SECONDS + INTERVAL_SECONDS))
          done

          echo "Timeout: Playwright tests did not complete after $MAX_WAIT_SECONDS seconds."
          echo "Dumping Docker logs of the whole compose setup..."
          docker compose -f src/docker-compose.ci.yml logs
          exit 1
