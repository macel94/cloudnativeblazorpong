apiVersion: batch/v1
kind: Job
metadata:
  name: db-init
  namespace: blazorpong
  labels:
    app.kubernetes.io/name: db-init
    app.kubernetes.io/part-of: blazorpong
spec:
  backoffLimit: 5
  template:
    metadata:
      labels:
        app.kubernetes.io/name: db-init
        app.kubernetes.io/part-of: blazorpong
    spec:
      restartPolicy: OnFailure
      containers:
        - name: db-init
          image: mcr.microsoft.com/dotnet/sdk:8.0
          imagePullPolicy: IfNotPresent
          env:
            - name: SA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: azuresql-credentials
                  key: SA_PASSWORD
          command:
            - bash
            - -euxc
            - |
              echo 'â¬‡ï¸ Installing sqlpackageâ€¦'
              dotnet tool install -g microsoft.sqlpackage
              export PATH="$PATH:/root/.dotnet/tools"

              echo 'â¬‡ï¸ Cloning repo to get DACPACâ€¦'
              apt-get update -qq && apt-get install -y -qq git >/dev/null
              git clone --depth 1 https://github.com/macel94/cloudnativeblazorpong.git /tmp/repo

              echo 'â³ Waiting for SQL Serverâ€¦'
              for i in $(seq 1 60); do
                sqlpackage /? >/dev/null 2>&1 && break || sleep 1
              done

              echo 'ðŸ“¦ Publishing DACPACâ€¦'
              sqlpackage /Action:Publish \
                /SourceFile:/tmp/repo/src/Blazorpong.DB.AzureSql/bin/Debug/Blazorpong.DB.AzureSql.dacpac \
                "/TargetConnectionString:Server=azuresql;Initial Catalog=BlazorpongDB;User ID=sa;Password=${SA_PASSWORD};Encrypt=False;TrustServerCertificate=True"

              echo 'ðŸŽ‰ Done.'
